# 日历改版说明

## 改版概述
将应用从传统的日期选择器改为日历视图，使用更直观的方式记录经期。

## 主要变化

### 1. 新增数据模型
- **PeriodRecord.kt**: 新的经期记录实体类
  - 支持单日期记录
  - 记录类型：开始日(1)、经期中(2)、结束日(3)
  - 使用periodId关联同一次经期的所有日期

- **PeriodRecordDao.kt**: 新的数据访问接口
  - 提供日历所需的各种查询方法
  - 支持按月份、按经期ID查询

### 2. 日历UI组件
- **CalendarView.kt**: 完整的日历视图组件
  - 月份导航（上一月/下一月）
  - 星期标题
  - 日期网格显示
  - 颜色编码：
    - 深粉色 (#E91E63): 经期开始
    - 中粉色 (#FF69B4): 经期结束
    - 浅粉色 (#FFB3D9): 经期中
    - 黄色 (#FFF59D): 待完成（已点击开始，等待结束）

### 3. 交互逻辑
#### 点击流程：
1. **第一次点击某日期**：标记为经期开始（深粉色）
2. **第二次点击另一日期**：
   - 标记为经期结束（中粉色）
   - 自动填充中间日期为经期中（浅粉色）
3. **第三次点击已标记日期**：删除整个经期记录

### 4. 数据库更新
- **DatesDatabase.kt**: 
  - 版本升级到 v4
  - 新增 PeriodRecord 表
  - 新增 periodRecordDao() 方法

### 5. 主界面更新
- **EnterDate.kt**: 
  - 集成日历视图
  - 移除旧的日期选择器对话框
  - 使用新的数据源进行周期分析
  
- **MainActivity.kt**:
  - 初始化 periodRecordDao
  - 传递给 EnterDate 组件

## 功能特性

### 用户体验改进
1. ✅ 直观的日历视图
2. ✅ 简单的点击交互（开始→结束→删除）
3. ✅ 视觉化的经期标记
4. ✅ 自动填充经期中的日期
5. ✅ 月份自由切换

### 数据功能
1. ✅ 保留周期分析功能
2. ✅ 自动计算下次月经预测
3. ✅ 显示排卵期等生理周期信息
4. ✅ 支持查看历史记录

## 技术细节

### 数据结构
```kotlin
PeriodRecord(
    date: LocalDate,          // 日期（主键）
    recordType: Int,          // 类型：1=开始，2=中间，3=结束
    periodId: Long,           // 经期ID（同一次经期相同）
    createdAt: Long          // 创建时间
)
```

### 关键函数
- `handleDateClick()`: 处理日期点击逻辑
- `CalendarGrid()`: 生成日历网格
- `CalendarDay()`: 单个日期单元格渲染

## 兼容性说明
- 保留了旧的 Dates 表和 DatesDao（向后兼容）
- 新旧数据可以共存
- 数据库使用 fallbackToDestructiveMigration()，首次运行会清空旧数据

## 使用说明

### 记录经期
1. 在日历上找到经期开始的日期
2. 点击该日期（变为深粉色）
3. 再点击经期结束的日期
4. 系统自动填充中间日期

### 删除记录
- 点击任何已标记的日期即可删除整个经期记录

### 查看分析
- 记录两次以上经期后，自动显示周期分析
- 包括周期长度、下次月经预测、排卵期等信息

## 后续优化建议
1. 添加经期症状记录
2. 支持自定义周期长度
3. 添加数据导出功能
4. 支持多设备同步
5. 添加提醒通知功能
